name: Test WebRTC Android Builder Action

on:
  workflow_dispatch:
    inputs:
      webrtc_branch:
        description: 'WebRTC branch to test'
        required: false
        default: 'branch-heads/7258'
        type: choice
        options:
          - 'branch-heads/7339'  # M140 (Beta - Next Stable)
          - 'branch-heads/7258'  # M139 (Stable - Current)
          - 'branch-heads/7204'  # M138 (Stable - Previous)
          - 'branch-heads/7151'  # M137 (Stable - LTS)
          - 'branch-heads/7103'  # M136 (Legacy)
          - 'branch-heads/7000'  # M135 (Legacy)
      
      target_arch:
        description: 'Target architectures'
        required: false
        default: 'arm64-v8a'
        type: choice
        options:
          - 'arm64-v8a'                    # ARM64 only (recommended for testing)
          - 'armeabi-v7a'                  # ARM32 only
          - 'armeabi-v7a,arm64-v8a'       # Both ARM architectures
          - 'x86_64'                       # x86 64-bit (emulator)
          - 'arm64-v8a,x86_64'            # ARM64 + x86_64 (most common)
      
      build_config:
        description: 'Build configuration'
        required: false
        default: 'release'
        type: choice
        options:
          - release
          - debug

  push:
    branches: [ test-* ]

jobs:
  test-action:
    runs-on: ubuntu-latest
    timeout-minutes: 300  # 5 hours for full build (increased for newer milestones)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Display Test Configuration
        run: |
          echo "🚀 Starting WebRTC Android Builder Test"
          echo "Branch: ${{ github.event.inputs.webrtc_branch }}"
          echo "Architecture: ${{ github.event.inputs.target_arch }}"
          echo "Build Config: ${{ github.event.inputs.build_config }}"
          echo "Expected milestone: Will be detected dynamically (Current stable: M139)"
      
      - name: Test WebRTC Android Builder (Local Action)
        id: webrtc_build
        uses: ./  # Use local action
        with:
          webrtc_branch: ${{ github.event.inputs.webrtc_branch }}
          target_arch: ${{ github.event.inputs.target_arch }}
          build_config: ${{ github.event.inputs.build_config }}
          # slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}  # Uncomment if you have Slack webhook
          # slack_channel: '#test-builds'
          # enable_slack_notifications: 'true'
      
      - name: Verify Build Output
        if: success()
        run: |
          echo "🔍 Verifying build outputs..."
          if [ -f webrtc-build/src/*.aar ]; then
            AAR_FILE=$(ls webrtc-build/src/*.aar | head -1)
            AAR_SIZE=$(stat -f%z "$AAR_FILE" 2>/dev/null || stat -c%s "$AAR_FILE" 2>/dev/null)
            AAR_SIZE_MB=$((AAR_SIZE / 1024 / 1024))
            echo "✅ AAR file found: $(basename "$AAR_FILE")"
            echo "📏 Size: ${AAR_SIZE_MB}MB"
            
            # Verify AAR structure (optional)
            echo "📦 AAR contents:"
            unzip -l "$AAR_FILE" | head -20
          else
            echo "❌ No AAR file found in webrtc-build/src/"
            exit 1
          fi
      
      - name: Upload Test Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: test-webrtc-aar-${{ github.run_number }}
          path: |
            webrtc-build/src/*.aar
            webrtc-build/src/build-info.txt
          retention-days: 7
      
      - name: Test Results Summary
        if: always()
        run: |
          echo "## 🧪 WebRTC Android Builder Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.event.inputs.webrtc_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture**: ${{ github.event.inputs.target_arch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Config**: ${{ github.event.inputs.build_config }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Information" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "- **AAR Filename**: ${{ steps.webrtc_build.outputs.aar_filename }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Build Info**: ${{ steps.webrtc_build.outputs.build_info }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Download URL**: ${{ steps.webrtc_build.outputs.download_url }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **Test completed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Test failed. Check logs for details.**" >> $GITHUB_STEP_SUMMARY
          fi